<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manual Camera AR</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            background: black;
            position: relative;
        }

        #videoContainer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        #cameraVideo {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* Mirror effect like selfie camera */
        }

        #arCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            pointer-events: none;
        }

        #controls {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            z-index: 10;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        #placeButton {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: #ff4444;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 18px;
            cursor: pointer;
            z-index: 10;
        }

        #switchCamera {
            position: absolute;
            bottom: 30px;
            right: 30px;
            background: #4444ff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 15px;
            font-size: 14px;
            cursor: pointer;
            z-index: 10;
        }

        .error {
            background: rgba(255,0,0,0.8);
            color: white;
            padding: 20px;
            text-align: center;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border-radius: 10px;
            z-index: 100;
        }
    </style>
</head>
<body>
    <div id="controls">
        üì± Camera should be normal size now! Tap the red button to place 3D objects.
    </div>

    <div id="videoContainer">
        <video id="cameraVideo" autoplay muted playsinline></video>
    </div>

    <canvas id="arCanvas"></canvas>

    <button id="placeButton">Place Object</button>
    <button id="switchCamera">Switch Camera</button>

    <script>
        let video, canvas, renderer, scene, camera, objects = [];
        let currentFacingMode = 'environment'; // Start with back camera
        let stream = null;

        async function initCamera() {
            try {
                video = document.getElementById('cameraVideo');

                // Stop existing stream if any
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }

                // Request camera with specific constraints
                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: currentFacingMode,
                        width: { ideal: 1280, max: 1920 },
                        height: { ideal: 720, max: 1080 }
                    },
                    audio: false
                });

                video.srcObject = stream;

                // Wait for video to be ready
                return new Promise((resolve) => {
                    video.onloadedmetadata = () => {
                        console.log('Video dimensions:', video.videoWidth, 'x', video.videoHeight);
                        resolve();
                    };
                });

            } catch (error) {
                console.error('Camera error:', error);
                showError('Camera access failed: ' + error.message);
            }
        }

        function initThreeJS() {
            canvas = document.getElementById('arCanvas');

            // Set canvas size
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            // Create Three.js scene
            scene = new THREE.Scene();

            // Create camera with proper aspect ratio
            camera = new THREE.PerspectiveCamera(
                70,
                window.innerWidth / window.innerHeight,
                0.1,
                1000
            );

            // Create renderer
            renderer = new THREE.WebGLRenderer({
                canvas: canvas,
                alpha: true,
                antialias: true
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);

            // Add lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(1, 1, 1);
            scene.add(directionalLight);

            // Start render loop
            animate();
        }

        function animate() {
            requestAnimationFrame(animate);

            // Rotate objects
            objects.forEach(obj => {
                obj.rotation.x += 0.01;
                obj.rotation.y += 0.02;
            });

            renderer.render(scene, camera);
        }

        function placeObject() {
            const colors = [0xff4444, 0x44ff44, 0x4444ff, 0xffff44, 0xff44ff, 0x44ffff];
            const shapes = ['box', 'sphere', 'cylinder'];

            const color = colors[Math.floor(Math.random() * colors.length)];
            const shape = shapes[Math.floor(Math.random() * shapes.length)];

            let geometry;
            switch(shape) {
                case 'sphere':
                    geometry = new THREE.SphereGeometry(0.5, 16, 16);
                    break;
                case 'cylinder':
                    geometry = new THREE.CylinderGeometry(0.3, 0.3, 1, 16);
                    break;
                default:
                    geometry = new THREE.BoxGeometry(0.8, 0.8, 0.8);
            }

            const material = new THREE.MeshLambertMaterial({ color: color });
            const object = new THREE.Mesh(geometry, material);

            // Place object in front of camera
            object.position.set(
                (Math.random() - 0.5) * 4,
                (Math.random() - 0.5) * 2,
                -3 - Math.random() * 2
            );

            scene.add(object);
            objects.push(object);

            updateStatus(`Placed ${objects.length} objects! Camera working normally?`);
        }

        function switchCamera() {
            currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';
            updateStatus('Switching camera...');
            initCamera();
        }

        function updateStatus(message) {
            document.getElementById('controls').innerHTML = `üì± ${message}`;
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.innerHTML = `‚ùå ${message}<br><button onclick="location.reload()">Retry</button>`;
            document.body.appendChild(errorDiv);
        }

        // Handle window resize
        window.addEventListener('resize', () => {
            if (camera && renderer) {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);

                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }
        });

        // Event listeners
        document.getElementById('placeButton').addEventListener('click', placeObject);
        document.getElementById('switchCamera').addEventListener('click', switchCamera);

        // Initialize everything
        async function init() {
            try {
                await initCamera();
                initThreeJS();
                updateStatus('Camera should be normal size! Tap red button to place 3D objects.');
            } catch (error) {
                showError('Initialization failed: ' + error.message);
            }
        }

        // Start the app
        init();
    </script>
</body>
</html>