<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Clean AR.js</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        /* Force proper video sizing */
        .arjs-video-container {
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
        }

        .arjs-video-container video {
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            object-fit: cover !important;
        }

        /* Hide AR.js loader */
        .arjs-loader {
            display: none !important;
        }

        #instructions {
            position: fixed;
            top: 10px;
            left: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 15px;
            border-radius: 8px;
            z-index: 1000;
            text-align: center;
            font-size: 14px;
        }

        #controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            gap: 10px;
        }

        .control-btn {
            background: #ff4444;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
        }

        .control-btn.secondary {
            background: #4444ff;
        }
    </style>
</head>
<body>
    <div id="instructions">
        ðŸŽ¯ Point camera at flat surfaces. Objects will stick to real world!
    </div>

    <div id="controls">
        <button class="control-btn" onclick="placeObject()">Place Object</button>
        <button class="control-btn secondary" onclick="clearObjects()">Clear All</button>
    </div>

    <a-scene
        vr-mode-ui="enabled: false"
        arjs="sourceType: webcam;
              debugUIEnabled: false;
              detectionMode: mono_and_matrix;
              matrixCodeType: 3x3;
              trackingMethod: best;
              sourceWidth: 1280; sourceHeight: 960;
              displayWidth: 1280; displayHeight: 960;"
        renderer="logarithmicDepthBuffer: true; colorManagement: true; sortObjects: true;"
        embedded
        gesture-detector
        id="scene">

        <!-- Assets -->
        <a-assets>
            <a-mixin id="clickable"
                     geometry="primitive: box; width: 0.3; height: 0.3; depth: 0.3"
                     material="transparent: true; opacity: 0.8"
                     animation__mouseenter="property: scale; to: 1.2 1.2 1.2; startEvents: mouseenter; dur: 200"
                     animation__mouseleave="property: scale; to: 1 1 1; startEvents: mouseleave; dur: 200">
            </a-mixin>
        </a-assets>

        <!-- Lighting -->
        <a-light type="ambient" color="#404040" intensity="0.4"></a-light>
        <a-light type="directional" position="0 1 1" color="#ffffff" intensity="0.6"></a-light>

        <!-- Simple marker-based tracking -->
        <a-marker preset="hiro" id="hiro-marker">
            <!-- Demo objects that appear on marker -->
            <a-box position="0 0.5 0"
                   scale="0.5 0.5 0.5"
                   material="color: #ff6b6b; transparent: true; opacity: 0.8"
                   animation="property: rotation; to: 0 360 0; loop: true; dur: 3000">
            </a-box>

            <a-sphere position="1 0.5 0"
                      radius="0.3"
                      material="color: #4ecdc4; transparent: true; opacity: 0.7"
                      animation="property: position; to: 1 1.2 0; dir: alternate; loop: true; dur: 2000">
            </a-sphere>

            <a-text value="AR Working!"
                    position="0 1.5 0"
                    align="center"
                    color="#ffe66d"
                    scale="1.5 1.5 1.5">
            </a-text>
        </a-marker>

        <!-- Camera -->
        <a-camera-static/>
    </a-scene>

    <script>
        let scene, objectCount = 0;

        // Wait for scene to load
        document.addEventListener('DOMContentLoaded', () => {
            scene = document.querySelector('#scene');

            // Fix video positioning after AR.js loads
            setTimeout(fixVideo, 2000);
            setTimeout(fixVideo, 5000);

            // Update instructions
            updateInstructions();
        });

        function fixVideo() {
            console.log('Attempting video fix...');

            // Find and fix video element positioning
            const videos = document.querySelectorAll('video');
            videos.forEach(video => {
                const container = video.parentElement;
                if (container) {
                    container.style.cssText = `
                        position: absolute !important;
                        top: 0 !important;
                        left: 0 !important;
                        width: 100% !important;
                        height: 100% !important;
                        z-index: -1 !important;
                    `;
                }

                video.style.cssText = `
                    position: absolute !important;
                    top: 0 !important;
                    left: 0 !important;
                    width: 100% !important;
                    height: 100% !important;
                    object-fit: cover !important;
                `;
            });
        }

        function placeObject() {
            if (!scene) return;

            const colors = ['#ff4444', '#44ff44', '#4444ff', '#ffff44', '#ff44ff', '#44ffff'];
            const shapes = ['box', 'sphere', 'cylinder', 'cone'];

            const color = colors[objectCount % colors.length];
            const shape = shapes[objectCount % shapes.length];

            // Create entity
            const entity = document.createElement('a-entity');
            entity.setAttribute('geometry', `primitive: ${shape}; radius: 0.2; height: 0.4`);
            entity.setAttribute('material', `color: ${color}; transparent: true; opacity: 0.8`);
            entity.setAttribute('position', `0 ${0.2 + objectCount * 0.3} ${-1 - objectCount * 0.2}`);
            entity.setAttribute('animation', 'property: rotation; to: 360 360 360; loop: true; dur: 4000');
            entity.classList.add('placed-object');

            // Add to marker
            const marker = document.querySelector('#hiro-marker');
            if (marker) {
                marker.appendChild(entity);
                objectCount++;
                updateInstructions();
            }
        }

        function clearObjects() {
            const objects = document.querySelectorAll('.placed-object');
            objects.forEach(obj => obj.remove());
            objectCount = 0;
            updateInstructions();
        }

        function updateInstructions() {
            const instructions = document.getElementById('instructions');
            if (objectCount === 0) {
                instructions.innerHTML = `ðŸŽ¯ Point camera at <a href="https://raw.githack.com/AR-js-org/AR.js/master/data/images/hiro.png" target="_blank" style="color:#44ff44;">HIRO marker</a> to see AR!`;
            } else {
                instructions.innerHTML = `ðŸŽ¯ ${objectCount} objects placed! Keep marker in view to see them.`;
            }
        }

        // Handle orientation changes
        window.addEventListener('orientationchange', () => {
            setTimeout(fixVideo, 500);
        });

        // Monitor for AR.js video creation
        const observer = new MutationObserver(() => {
            setTimeout(fixVideo, 100);
        });

        observer.observe(document.body, {
            childList: true,
            subtree: true
        });
    </script>
</body>
</html>