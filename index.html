<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebXR AR</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body {
            margin: 0;
            background: black;
            color: white;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            text-align: center;
        }

        #startButton {
            padding: 20px 40px;
            font-size: 20px;
            background: #00ff88;
            color: black;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            margin: 20px;
            font-weight: bold;
        }

        #startButton:disabled {
            background: #666;
            cursor: not-allowed;
        }

        #status {
            margin: 20px;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            max-width: 400px;
        }

        .error { color: #ff4444; }
        .success { color: #44ff44; }
        .info { color: #4444ff; }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <div id="content">
        <h1>ðŸš€ WebXR AR</h1>
        <div id="status">Checking AR support...</div>
        <button id="startButton" disabled>Start AR</button>
        <div style="margin-top: 20px; font-size: 14px; opacity: 0.8;">
            <p>This uses modern WebXR - no markers needed!</p>
            <p>Tap screen to place objects on real surfaces</p>
        </div>
    </div>

    <script>
        let scene, camera, renderer, controller, reticle, hitTestSource, localSpace;
        let arObjects = [];

        const startButton = document.getElementById('startButton');
        const statusDiv = document.getElementById('status');
        const contentDiv = document.getElementById('content');

        // Check WebXR support
        async function checkARSupport() {
            if (!('xr' in navigator)) {
                updateStatus('âŒ WebXR not supported in this browser', 'error');
                return false;
            }

            try {
                const supported = await navigator.xr.isSessionSupported('immersive-ar');
                if (supported) {
                    updateStatus('âœ… WebXR AR supported! Ready to start.', 'success');
                    startButton.disabled = false;
                    startButton.addEventListener('click', startAR);
                    return true;
                } else {
                    updateStatus('âš ï¸ WebXR AR not supported on this device', 'error');
                    return false;
                }
            } catch (error) {
                updateStatus('âŒ Error checking AR support: ' + error.message, 'error');
                return false;
            }
        }

        function updateStatus(message, type = 'info') {
            statusDiv.innerHTML = message;
            statusDiv.className = type;
        }

        async function startAR() {
            try {
                updateStatus('ðŸš€ Starting AR session...', 'info');

                // Initialize Three.js
                scene = new THREE.Scene();
                camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);

                renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                renderer.setPixelRatio(window.devicePixelRatio);
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.xr.enabled = true;
                renderer.setClearColor(0x000000, 0);

                document.body.appendChild(renderer.domElement);
                contentDiv.style.display = 'none';

                // Lighting
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
                scene.add(ambientLight);

                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                directionalLight.position.set(0, 1, 1);
                scene.add(directionalLight);

                // Create reticle (targeting indicator)
                const reticleGeometry = new THREE.RingGeometry(0.15, 0.2, 32);
                const reticleMaterial = new THREE.MeshBasicMaterial({
                    color: 0xffffff,
                    transparent: true,
                    opacity: 0.5
                });
                reticle = new THREE.Mesh(reticleGeometry, reticleMaterial);
                reticle.matrixAutoUpdate = false;
                reticle.visible = false;
                scene.add(reticle);

                // Start AR session
                const session = await navigator.xr.requestSession('immersive-ar', {
                    requiredFeatures: ['hit-test'],
                    optionalFeatures: ['dom-overlay'],
                    domOverlay: { root: document.body }
                });

                await renderer.xr.setSession(session);

                // Set up reference spaces
                const referenceSpace = await session.requestReferenceSpace('local');
                const viewerSpace = await session.requestReferenceSpace('viewer');
                hitTestSource = await session.requestHitTestSource({ space: viewerSpace });
                localSpace = referenceSpace;

                // Set up controller for screen taps
                controller = renderer.xr.getController(0);
                controller.addEventListener('select', onSelect);
                scene.add(controller);

                // Start render loop
                renderer.setAnimationLoop(render);

                updateStatus('âœ… AR Active! Look around and tap to place objects', 'success');

            } catch (error) {
                console.error('AR startup error:', error);
                updateStatus('âŒ AR failed to start: ' + error.message, 'error');
                contentDiv.style.display = 'block';
            }
        }

        function onSelect() {
            if (reticle.visible) {
                // Create different objects
                const objects = [
                    () => new THREE.BoxGeometry(0.1, 0.1, 0.1),
                    () => new THREE.SphereGeometry(0.05, 16, 16),
                    () => new THREE.CylinderGeometry(0.05, 0.05, 0.1, 16),
                    () => new THREE.ConeGeometry(0.05, 0.1, 16)
                ];

                const colors = [0xff4444, 0x44ff44, 0x4444ff, 0xffff44, 0xff44ff, 0x44ffff];

                const geometry = objects[Math.floor(Math.random() * objects.length)]();
                const material = new THREE.MeshLambertMaterial({
                    color: colors[Math.floor(Math.random() * colors.length)]
                });
                const mesh = new THREE.Mesh(geometry, material);

                // Position at reticle location
                mesh.position.setFromMatrixPosition(reticle.matrix);
                mesh.rotation.y = Math.random() * Math.PI * 2;

                scene.add(mesh);
                arObjects.push(mesh);

                // Add spinning animation
                mesh.userData.rotationSpeed = (Math.random() - 0.5) * 0.1;

                console.log('Placed object #' + arObjects.length);
            }
        }

        function render(timestamp, frame) {
            if (frame) {
                // Hit testing for surface detection
                if (hitTestSource) {
                    const hitTestResults = frame.getHitTestResults(hitTestSource);

                    if (hitTestResults.length > 0) {
                        const hit = hitTestResults[0];
                        const pose = hit.getPose(localSpace);

                        if (pose) {
                            reticle.visible = true;
                            reticle.matrix.fromArray(pose.transform.matrix);
                        }
                    } else {
                        reticle.visible = false;
                    }
                }
            }

            // Animate objects
            arObjects.forEach(obj => {
                if (obj.userData.rotationSpeed) {
                    obj.rotation.y += obj.userData.rotationSpeed;
                }
            });

            renderer.render(scene, camera);
        }

        // Handle window resize
        window.addEventListener('resize', () => {
            if (camera && renderer) {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }
        });

        // Initialize
        checkARSupport();
    </script>
</body>
</html>